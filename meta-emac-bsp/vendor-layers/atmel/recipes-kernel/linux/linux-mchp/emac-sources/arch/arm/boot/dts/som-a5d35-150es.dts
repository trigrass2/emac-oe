// SPDX-License-Identifier: GPL-2.0-or-later
/*
 * som-a5d35-150es.dts - Device Tree file for the SOM-A5D35 w/ a 150es EMAC Carrier.
 *
 * Copyright (C) 2023 EMAC Inc.
 *
 */

/dts-v1/;
#include "som-a5d35-1xx.dts"

/{
    model = "EMAC SoM-A5D35 within SoM-150ES";

    clocks {
        audio_clk: oscillator-cpld-in { // always on, fed into cpld and turned into prescale-a
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-output-names = "osc-a";
			clock-frequency = <24576000>;
		};
        audio_clk_prescale: oscillator-cpld-out { // always on...
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-output-names = "prescale-a";
			clock-frequency = <12288000>;
		};
        clk_200khz: clk-200khz {
            compatible = "pwm-clock";
            #clock-cells = <0>;
            clock-frequency = <200000>;
            pwms = <&tcb0_pwm0 1 5000 0>; /* 200 kHz */
        };
        clk_8mhz: clk-8mhz {
            compatible = "pwm-clock";
            #clock-cells = <0>;
            clock-frequency = <8000000>;
            pwms = <&tcb0_pwm1 0 125 0>; /* 8 MHz */
        };
    };
    regulators {
        power_12v_acc: carrier-12v-acc@9 {
			compatible = "regulator-fixed";
            reg = <9>;
			regulator-name = "12V_ACC";
			regulator-min-microvolt = <12000000>;
			regulator-max-microvolt = <12000000>;
		};
    };

    auxdisplay {
        compatible = "hit,hd44780";

        data-gpios = <&pldioLCD 0 GPIO_ACTIVE_HIGH>,
                    <&pldioLCD 1 GPIO_ACTIVE_HIGH>,
                    <&pldioLCD 2 GPIO_ACTIVE_HIGH>,
                    <&pldioLCD 3 GPIO_ACTIVE_HIGH>;
        enable-gpios = <&pldioLCD 4 GPIO_ACTIVE_HIGH>;
        rs-gpios = <&pldioLCD 5 GPIO_ACTIVE_HIGH>;

        display-height-chars = <2>;
        display-width-chars = <16>;
        status = "okay";
    };

    matrix-keypad {
        compatible = "gpio-matrix-keypad";
        pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_keypad_irq>;
        debounce-delay-ms = <5>;
        col-scan-delay-us = <2>;
        wakeup-source = <&pioE 31 0>;
        status = "okay";

        row-gpios = <&pldioF 0 0
                    &pldioF 1 0
                    &pldioF 2 0
                    &pldioF 3 0>;

        col-gpios = <&pldioF 4 0
                    &pldioF 5 0
                    &pldioF 6 0
                    &pldioF 7 0>;

        linux,keymap = <0x0000001e /*A*/
                0x01000008 /*7*/
                0x02000005 /*4*/
                0x03000002 /*1*/
                0x0001000b /*0*/
                0x01010009 /*8*/
                0x02010006 /*5*/
                0x03010003 /*2*/
                0x00020030 /*B*/
                0x0102000a /*9*/
                0x02020007 /*6*/
                0x03020004 /*3*/
                0x00030021 /*F*/
                0x01030012 /*E*/
                0x02030020 /*D*/
                0x0303002e /*C*/
                >;
    };
};
&audio_center {
    status = "okay";
	simple-audio-card,name = "cs4271";
    simple-audio-card,bitclock-master = <&codec_master>;
	simple-audio-card,frame-master = <&codec_master>;
    codec_master: simple-audio-card,codec {
        sound-dai = <&cs4271>;
    };
};

&ssc1 {
    status = "okay";
};

&mmc1 {
    slot@0 {
        cd-gpios = <&pioC 13 GPIO_ACTIVE_LOW>;
    };
};
&spi0 {
    mcp3208: mcp320x@1 {
        compatible = "microchip,mcp3208";
        spi-max-frequency = <1000000>;
        spi-cpol;
        spi-cpha;
        reg = <1>;
        status = "okay";
    };

    mcp4922: mcp49x2@2 {
        compatible = "mcp4922";
        spi-max-frequency = <1000000>;
        spi-cpol;
        spi-cpha;
        reg = <2>;
        vref = <&adc_vref>;
        status = "okay";
    };

    cs4271: cs4271@3 {
        #sound-dai-cells = <0>;
        compatible = "cirrus,cs4271";
        spi-cpol;
        spi-cpha;
        reg = <3>;
        clocks = <&audio_clk_prescale>;
        spi-max-frequency = <1000000>;
        status = "okay";
    };
};

&usart3 {
    // CPLD isnt working
    // rts-gpios = <&pldioD 0 GPIO_ACTIVE_LOW>;
    // cts-gpios = <&pldioD 1 GPIO_ACTIVE_LOW>;
};

&tcb0 {
    status = "okay";
    tcb0_pwm0: pwm@1 {
        compatible = "atmel,tcb-pwm";
        #pwm-cells = <3>;
        reg = <0>;
        pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_tcb0_tiob0>;
        status = "okay";
    };
    tcb0_pwm1: pwm@2 {
        compatible = "atmel,tcb-pwm";
        #pwm-cells = <3>;
        reg = <1>;
        pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_tcb0_tioa1>;
        status = "okay";
    };
};

&ebi {
    pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_ebi_addr_6>;
    status = "okay";
    pldioA: cpld@3,2 {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat", "dirout";
        reg = <3 2 1>, <3 3 1>;
        gpio-controller;
        #gpio-cells = <2>;
        #address-cells = <1>;
        #size-cells = <1>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;

        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nrd-setup-ns = <16>;
        atmel,smc-ncs-wr-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <16>;
        atmel,smc-ncs-rd-pulse-ns = <40>;
        atmel,smc-nrd-pulse-ns = <24>;
        atmel,smc-ncs-wr-pulse-ns = <40>;
        atmel,smc-nwe-pulse-ns = <24>;
        atmel,smc-nwe-cycle-ns = <64>;
        atmel,smc-nrd-cycle-ns = <64>;
        atmel,smc-tdf-ns = <16>;
    };

    
    pldioB: cpld@3,4 {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat", "dirout";
        reg = <3 4 1>, <3 5 1>;
        gpio-controller;
        #address-cells = <1>;
        #size-cells = <1>;
        #gpio-cells = <2>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;

        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nrd-setup-ns = <16>;
        atmel,smc-ncs-wr-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <16>;
        atmel,smc-ncs-rd-pulse-ns = <40>;
        atmel,smc-nrd-pulse-ns = <24>;
        atmel,smc-ncs-wr-pulse-ns = <40>;
        atmel,smc-nwe-pulse-ns = <24>;
        atmel,smc-nwe-cycle-ns = <64>;
        atmel,smc-nrd-cycle-ns = <64>;
        atmel,smc-tdf-ns = <16>;
    };

    pldioC: cpld@3,6 {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat";
        reg = <3 6 1>;
        gpio-controller;
        no-input;
        #address-cells = <1>;
        #size-cells = <1>;
        #gpio-cells = <2>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;

        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nrd-setup-ns = <16>;
        atmel,smc-ncs-wr-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <16>;
        atmel,smc-ncs-rd-pulse-ns = <40>;
        atmel,smc-nrd-pulse-ns = <24>;
        atmel,smc-ncs-wr-pulse-ns = <40>;
        atmel,smc-nwe-pulse-ns = <24>;
        atmel,smc-nwe-cycle-ns = <64>;
        atmel,smc-nrd-cycle-ns = <64>;
        atmel,smc-tdf-ns = <16>;
    };


    pldioD: cpld@3,8 {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat";
        reg = <3 8 1>;
        gpio-controller;
        no-input;
        #address-cells = <1>;
        #size-cells = <1>;
        #gpio-cells = <2>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;

        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nrd-setup-ns = <16>;
        atmel,smc-ncs-wr-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <16>;
        atmel,smc-ncs-rd-pulse-ns = <40>;
        atmel,smc-nrd-pulse-ns = <24>;
        atmel,smc-ncs-wr-pulse-ns = <40>;
        atmel,smc-nwe-pulse-ns = <24>;
        atmel,smc-nwe-cycle-ns = <64>;
        atmel,smc-nrd-cycle-ns = <64>;
        atmel,smc-tdf-ns = <16>;
    };

    pldioE: cpld@3,10 {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat", "dirout";
        reg = <3 10 1>, <3 11 1>;
        gpio-controller;
        #address-cells = <1>;
        #size-cells = <1>;
        #gpio-cells = <2>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;

        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nrd-setup-ns = <16>;
        atmel,smc-ncs-wr-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <16>;
        atmel,smc-ncs-rd-pulse-ns = <40>;
        atmel,smc-nrd-pulse-ns = <24>;
        atmel,smc-ncs-wr-pulse-ns = <40>;
        atmel,smc-nwe-pulse-ns = <24>;
        atmel,smc-nwe-cycle-ns = <64>;
        atmel,smc-nrd-cycle-ns = <64>;
        atmel,smc-tdf-ns = <16>;
    };

    pldioF: cpld@3,7 {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat";
        reg = <3 7 1>;
        gpio-controller;
        #address-cells = <1>;
        #size-cells = <1>;
        #gpio-cells = <2>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;

        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nrd-setup-ns = <16>;
        atmel,smc-ncs-wr-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <16>;
        atmel,smc-ncs-rd-pulse-ns = <40>;
        atmel,smc-nrd-pulse-ns = <24>;
        atmel,smc-ncs-wr-pulse-ns = <40>;
        atmel,smc-nwe-pulse-ns = <24>;
        atmel,smc-nwe-cycle-ns = <64>;
        atmel,smc-nrd-cycle-ns = <64>;
        atmel,smc-tdf-ns = <16>;        
    };

    cpld_id: cpld@3,0xf {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat";
        reg = <3 0xf 1>;
        gpio-controller;
        no-input;
        #address-cells = <1>;
        #size-cells = <1>;
        #gpio-cells = <2>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;

        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nrd-setup-ns = <16>;
        atmel,smc-ncs-wr-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <16>;
        atmel,smc-ncs-rd-pulse-ns = <40>;
        atmel,smc-nrd-pulse-ns = <24>;
        atmel,smc-ncs-wr-pulse-ns = <40>;
        atmel,smc-nwe-pulse-ns = <24>;
        atmel,smc-nwe-cycle-ns = <64>;
        atmel,smc-nrd-cycle-ns = <64>;
        atmel,smc-tdf-ns = <16>;
    };

    pldioLCD: cpld@3,0 {
        compatible = "brcm,bcm6345-gpio";
        reg-names = "dat", "dirout";
        reg = <3 0 1>, <3 1 1>;
        gpio-controller;
        #gpio-cells = <2>;
        #address-cells = <1>;
        #size-cells = <1>;
        bank-width = <1>;

        atmel,smc-read-mode = "nrd";
        atmel,smc-write-mode = "nwe";
        atmel,smc-bus-width = <8>;
        atmel,smc-ncs-rd-setup-ns = <8>;
        atmel,smc-nwe-setup-ns = <27>;
        atmel,smc-ncs-wr-setup-ns = <16>;
        atmel,smc-nrd-setup-ns = <6>;
        atmel,smc-ncs-rd-pulse-ns = <6>;
        atmel,smc-nrd-pulse-ns = <6>;
        atmel,smc-ncs-wr-pulse-ns = <81>;
        atmel,smc-nwe-pulse-ns = <94>;
        atmel,smc-nwe-cycle-ns = <128>;
        atmel,smc-nrd-cycle-ns = <14>;
        atmel,smc-tdf-ns = <15>;
    };
};

&pinctrl {
    ebi {
        pinctrl_ebi_addr_6: ebi-addr-6 {
			atmel,pins =
				<AT91_PIOE 0 AT91_PERIPH_A AT91_PINCTRL_NONE
					AT91_PIOE 1 AT91_PERIPH_A AT91_PINCTRL_NONE
					AT91_PIOE 2 AT91_PERIPH_A AT91_PINCTRL_NONE
					AT91_PIOE 3 AT91_PERIPH_A AT91_PINCTRL_NONE
					AT91_PIOE 4 AT91_PERIPH_A AT91_PINCTRL_NONE
					AT91_PIOE 5 AT91_PERIPH_A AT91_PINCTRL_NONE>;
		};
        pinctrl_keypad_irq: keypad-irq {
			atmel,pins =
				<AT91_PIOE 31 AT91_PERIPH_GPIO AT91_PINCTRL_DEBOUNCE>;
		};
    };
    tcb0 {
        pinctrl_tcb0_tiob0: tcb0_tiob0 {
            atmel,pins =
                <AT91_PIOD 6 AT91_PERIPH_B AT91_PINCTRL_NONE>;
        };
        pinctrl_tcb0_tioa1: tcb0_tioa1 {
            atmel,pins =
                <AT91_PIOC 12 AT91_PERIPH_B AT91_PINCTRL_NONE>;
        };
    };
};
