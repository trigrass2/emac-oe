From a4886704e0739d6206f775a6b41aa1144dc7db45 Mon Sep 17 00:00:00 2001
From: Brenden Tisler <btisler@emacinc.com>
Date: Thu, 6 Jul 2023 19:07:14 -0500
Subject: [PATCH] som 5728 changes

Signed-off-by: Brenden Tisler <btisler@emacinc.com>
---
 arch/arm/dts/emac-som-5728m.dtsi   |  38 +++----
 board/emacinc/som-5728m/board.c    |  62 +++++++---
 board/emacinc/som-5728m/mux_data.h |   1 +
 configs/emac-som-5728m_defconfig   | 176 +++++++++--------------------
 4 files changed, 114 insertions(+), 163 deletions(-)

diff --git a/arch/arm/dts/emac-som-5728m.dtsi b/arch/arm/dts/emac-som-5728m.dtsi
index 4952a6336c..d074b368d6 100644
--- a/arch/arm/dts/emac-som-5728m.dtsi
+++ b/arch/arm/dts/emac-som-5728m.dtsi
@@ -449,35 +449,25 @@
 	dr_mode = "host";
 };
 
-&mac{
-	slaves = <1>;
-	status = "okay";
-};
-
 &davinci_mdio {
-    ethphy4: ethernet-phy@4 {
+	reset-gpios = <&gpio4 25 GPIO_ACTIVE_LOW>;
+	reset-delay-us = <2>;
+
+	phy0: ethernet-phy@1 {
 		reg = <4>;
-		qca,clk-out-frequency = <50000000>;
-		qca,keep-pll-enabled;
-		vddio-supply = <&vddio>;
-		reset-gpios = <&gpio4 25 GPIO_ACTIVE_LOW>;
-    	reset-assert-us = <500000>;
-		reset-deassert-us = <500000>;
-
-		vddio: vddio-regulator {
-			regulator-min-microvolt = <1500000>;
-			regulator-max-microvolt = <1500000>;
-		};
-    };
+		eee-broken-100tx;
+		eee-broken-1000t;
+	};
 };
 
-&cpsw_emac0 {
-    phy-handle = <&ethphy4>;
-    phy-mode = "rgmii";
-	ti,dual-emac-pvid = <1>;
+&mac {
+	slaves = <1>;
+	status = "okay";
 };
-&cpsw_emac1 {
-    status = "disabled";
+
+&cpsw_emac0 {
+	phy-handle = <&phy0>;
+	phy-mode = "rgmii";
 };
 
 &usb2_phy1 {
diff --git a/board/emacinc/som-5728m/board.c b/board/emacinc/som-5728m/board.c
index 4540609c38..8f1ae5483f 100644
--- a/board/emacinc/som-5728m/board.c
+++ b/board/emacinc/som-5728m/board.c
@@ -504,34 +504,55 @@ static struct cpsw_slave_data cpsw_slaves[] = {
 static struct cpsw_platform_data cpsw_data = {
 	.mdio_base		= CPSW_MDIO_BASE,
 	.cpsw_base		= CPSW_BASE,
-	.mdio_div		= 0xff,
+	.mdio_div		= CPSW_MDIO_DIV,
 	.channels		= 8,
-	.cpdma_reg_ofs		= 0x800,
+	.cpdma_reg_ofs		= CPSW_CPDMA_OFFSET,
 	.slaves			= 1,
 	.slave_data		= cpsw_slaves,
-	.ale_reg_ofs		= 0xd00,
+	.ale_reg_ofs		= CPSW_ALE_OFFSET,
 	.ale_entries		= 1024,
-	.host_port_reg_ofs	= 0x108,
-	.hw_stats_reg_ofs	= 0x900,
-	.bd_ram_ofs		= 0x2000,
+	.host_port_reg_ofs	= CPSW_HOST_PORT_OFFSET,
+	.hw_stats_reg_ofs	= CPSW_HW_STATS,
+	.bd_ram_ofs		= CPSW_BD_OFFSET,
 	.mac_control		= (1 << 5),
 	.control		= cpsw_control,
 	.host_port_num		= 0,
 	.version		= CPSW_CTRL_VERSION_2,
 };
 
+static int ar8031_phy_fixup(struct phy_device *phydev)
+{
+	unsigned short val;
+
+	/* To enable AR8031 ouput a 125MHz clk from CLK_25M */
+	phy_write(phydev, MDIO_DEVAD_NONE, 0xd, 0x7);
+	phy_write(phydev, MDIO_DEVAD_NONE, 0xe, 0x8016);
+	phy_write(phydev, MDIO_DEVAD_NONE, 0xd, 0x4007);
+
+	val = phy_read(phydev, MDIO_DEVAD_NONE, 0xe);
+	val &= 0xffe3;
+	val |= 0x18;
+	phy_write(phydev, MDIO_DEVAD_NONE, 0xe, val);
+
+	/* introduce tx clock delay */
+	phy_write(phydev, MDIO_DEVAD_NONE, 0x1d, 0x5);
+	val = phy_read(phydev, MDIO_DEVAD_NONE, 0x1e);
+	val |= 0x0100;
+	phy_write(phydev, MDIO_DEVAD_NONE, 0x1e, val);
+
+	return 0;
+}
+
 int board_phy_config(struct phy_device *phydev)
 {
-#define GPIO_PHY_RST GPIO_TO_PIN(4, 25)
-	int ret = 0;
-	if (phydev->drv->config)
-		ret = phydev->drv->config(phydev);
-	gpio_request(GPIO_PHY_RST, "phy_rst");
-	gpio_direction_output(GPIO_PHY_RST, 0);
-	udelay(500*1000);
-	gpio_direction_output(GPIO_PHY_RST, 1);
-	udelay(500*1000);
-	return ret;
+	ar8031_phy_fixup(phydev);
+
+	if (phydev->drv->config){
+		printf("%s conf", phydev->drv->name);
+		phydev->drv->config(phydev);
+	};
+
+	return 0;
 }
 
 static u64 mac_to_u64(u8 mac[6])
@@ -589,6 +610,8 @@ int board_eth_init(struct bd_info *bis)
 	ctrl_val |= 0x22;
 	writel(ctrl_val, (*ctrl)->control_core_control_io1);
 
+	cpsw_data.slave_data[0].phy_addr = 4;
+
 	ret = cpsw_register(&cpsw_data);
 	if (ret < 0)
 		printf("Error %d registering CPSW switch\n", ret);
@@ -611,6 +634,13 @@ static inline void status_led_enable(void)
 int board_early_init_f(void)
 {
 	status_led_enable();
+#define GPIO_PHY_RST GPIO_TO_PIN(4, 25)
+
+	gpio_request(GPIO_PHY_RST, "phy_rst");
+	gpio_direction_output(GPIO_PHY_RST, 0);
+	udelay(100000);
+	gpio_direction_output(GPIO_PHY_RST, 1);
+	udelay(500000);
 	return 0;
 }
 #endif
diff --git a/board/emacinc/som-5728m/mux_data.h b/board/emacinc/som-5728m/mux_data.h
index cbe2f5630a..ba4e4e9795 100644
--- a/board/emacinc/som-5728m/mux_data.h
+++ b/board/emacinc/som-5728m/mux_data.h
@@ -62,6 +62,7 @@ const struct pad_conf_entry core_padconf_array_essential_som_5728m[] = {
 	{VIN2A_D15, 0x5000A}, /* C4 vin2a_d15.eQEP3_index */
 	{VIN2A_D10, 0x10003}, /* D3 vin2a_d10.mdio_mclk */
 	{VIN2A_D11, 0x10003}, /* F6 vin2a_d11.mdio_d */
+	{RMII_MHZ_50_CLK, (M14 | PIN_INPUT_PULLUP)},	/* RMII_MHZ_50_CLK.gpio5_17 */
 	{RGMII0_RXD1, 0x50100}, /* Y2 rgmii0_rxd1.rgmii0_rxd1 */
 	{RGMII0_RXD2, 0x50100}, /* V3 rgmii0_rxd2.rgmii0_rxd2 */
 	{RGMII0_RXD3, 0x50100}, /* V4 rgmii0_rxd3.rgmii0_rxd3 */
diff --git a/configs/emac-som-5728m_defconfig b/configs/emac-som-5728m_defconfig
index 9550c8e1c6..ec49b70e2b 100644
--- a/configs/emac-som-5728m_defconfig
+++ b/configs/emac-som-5728m_defconfig
@@ -1,202 +1,132 @@
 CONFIG_ARM=y
 CONFIG_ARCH_OMAP2PLUS=y
-CONFIG_SYS_MALLOC_F_LEN=0x18000
-CONFIG_TI_COMMON_CMD_OPTIONS=y
 CONFIG_NR_DRAM_BANKS=2
 CONFIG_HAS_CUSTOM_SYS_INIT_SP_ADDR=y
-CONFIG_CUSTOM_SYS_INIT_SP_ADDR=0x4037fef0
+CONFIG_CUSTOM_SYS_INIT_SP_ADDR=0x4037ff00
 CONFIG_DM_GPIO=y
 CONFIG_SPL_DM_SPI=y
 CONFIG_DEFAULT_DEVICE_TREE="emac-som-5728m-350es"
 CONFIG_SPL_TEXT_BASE=0x40300000
 CONFIG_OMAP54XX=y
-CONFIG_SYS_PROMPT=">>> "
+CONFIG_SYS_PROMPT=">>>"
 CONFIG_TARGET_EMAC_SOM_5728M=y
-CONFIG_DM_RESET=y
-CONFIG_BOOTCOUNT_BOOTLIMIT=5
-CONFIG_SPL_SIZE_LIMIT=0x80000
 CONFIG_SPL=y
+CONFIG_ENV_OFFSET_REDUND=0x280000
+CONFIG_SPL_SPI_FLASH_SUPPORT=y
+CONFIG_SPL_SPI=y
 CONFIG_ARMV7_LPAE=y
-CONFIG_CMD_HDMIDETECT=y
-CONFIG_ENV_ADDR=0xC0000
-CONFIG_SPL_PAYLOAD="u-boot.img"
 CONFIG_AHCI=y
-CONFIG_PHYS_64BIT=y
-# CONFIG_FIT is not set
+CONFIG_SPL_LOAD_FIT=y
 CONFIG_OF_BOARD_SETUP=y
-CONFIG_OF_STDOUT_VIA_ALIAS=y
 CONFIG_DISTRO_DEFAULTS=y
-CONFIG_QSPI_BOOT=y
-CONFIG_SATA_BOOT=y
 CONFIG_SD_BOOT=y
 CONFIG_SPI_BOOT=y
-CONFIG_AUTOBOOT_USE_MENUKEY=y
-CONFIG_AUTOBOOT_MENUKEY=120
-CONFIG_USE_BOOTARGS=y
+# CONFIG_USE_BOOTCOMMAND is not set
 CONFIG_DEFAULT_FDT_FILE="emac-som-5728m-350es.dtb"
-CONFIG_SYS_CONSOLE_ENV_OVERWRITE=y
 CONFIG_SYS_CONSOLE_INFO_QUIET=y
-CONFIG_LOGF_FILE=y
-CONFIG_LOGF_LINE=y
-CONFIG_LOGF_FUNC=y
-CONFIG_SPL_LOG=y
-CONFIG_LOG_ERROR_RETURN=y
-CONFIG_BOARD_TYPES=y
-CONFIG_DISPLAY_BOARDINFO_LATE=y
 CONFIG_BOARD_EARLY_INIT_F=y
-CONFIG_SPL_BOOTCOUNT_LIMIT=y
+# CONFIG_MISC_INIT_R is not set
+CONFIG_AVB_VERIFY=y
+CONFIG_SPL_MAX_SIZE=0x7bc00
 CONFIG_SPL_SYS_MALLOC_SIMPLE=y
-# CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_SECTOR is not set
+CONFIG_SYS_SPL_MALLOC=y
+CONFIG_SYS_SPL_MALLOC_SIZE=0x800000
 CONFIG_SPL_DMA=y
-CONFIG_SPL_SAVEENV=y
-CONFIG_SPL_FAT_WRITE=y
+CONFIG_SPL_FS_LOAD_PAYLOAD_NAME="u-boot.img"
 # CONFIG_SPL_NAND_SUPPORT is not set
-CONFIG_SPL_NAND_ECC=y
 CONFIG_SPL_DM_SPI_FLASH=y
-CONFIG_SPL_PCI=y
-CONFIG_SPL_DM_RESET=y
-CONFIG_SPL_RAM_SUPPORT=y
-CONFIG_SPL_REMOTEPROC=y
-CONFIG_SPL_USB_GADGET=y
-CONFIG_CMD_CONFIG=y
-# CONFIG_BOOTM_NETBSD is not set
-# CONFIG_BOOTM_PLAN9 is not set
-# CONFIG_BOOTM_RTEMS is not set
-# CONFIG_BOOTM_VXWORKS is not set
-CONFIG_CMD_BOOTEFI_HELLO=y
-CONFIG_CMD_BOOTMENU=y
-# CONFIG_CMD_ELF is not set
-# CONFIG_CMD_IMI is not set
-# CONFIG_CMD_XIMG is not set
-CONFIG_CMD_GREPENV=y
-CONFIG_CMD_ENV_CALLBACK=y
-CONFIG_CMD_ENV_FLAGS=y
-CONFIG_CMD_NVEDIT_EFI=y
-CONFIG_CMD_NVEDIT_INFO=y
-CONFIG_CRC32_VERIFY=y
-# CONFIG_CMD_EEPROM is not set
-CONFIG_CMD_MD5SUM=y
-CONFIG_MD5SUM_VERIFY=y
-CONFIG_CMD_MEMINFO=y
-# CONFIG_CMD_DFU is not set
+CONFIG_SPL_OS_BOOT=y
+CONFIG_SPL_FALCON_BOOT_MMCSD=y
+CONFIG_SYS_MMCSD_RAW_MODE_KERNEL_SECTOR=0x1700
+CONFIG_SYS_MMCSD_RAW_MODE_ARGS_SECTOR=0x1500
+CONFIG_SYS_MMCSD_RAW_MODE_ARGS_SECTORS=0x200
+CONFIG_SPL_SPI_LOAD=y
+CONFIG_SYS_SPI_U_BOOT_OFFS=0x40000
+# CONFIG_SPL_THERMAL is not set
+CONFIG_SPL_YMODEM_SUPPORT=y
+CONFIG_SYS_MAXARGS=64
+CONFIG_SYS_BOOTM_LEN=0x4000000
+CONFIG_CMD_ADTIMG=y
+CONFIG_CMD_ABOOTIMG=y
+CONFIG_CMD_SPL=y
+CONFIG_CMD_BCB=y
 CONFIG_CMD_DM=y
+# CONFIG_CMD_FASTBOOT is not set
 # CONFIG_CMD_FLASH is not set
-CONFIG_CMD_GPT_RENAME=y
-CONFIG_CMD_LSBLK=y
+CONFIG_CMD_GPIO=y
+CONFIG_CMD_MMC=y
 CONFIG_CMD_CLONE=y
-CONFIG_CMD_PCI=y
-CONFIG_CMD_SF_TEST=y
+CONFIG_CMD_USB=y
 CONFIG_CMD_USB_MASS_STORAGE=y
+# CONFIG_CMD_SETEXPR is not set
 CONFIG_BOOTP_DNS2=y
-CONFIG_CMD_TFTPSRV=y
 CONFIG_CMD_WGET=y
 CONFIG_CMD_DNS=y
-CONFIG_CMD_LINK_LOCAL=y
-CONFIG_CMD_BOOTCOUNT=y
-CONFIG_CMD_EXCEPTION=y
-CONFIG_CMD_SOUND=y
-CONFIG_CMD_AES=y
-CONFIG_CMD_HASH=y
-CONFIG_HASH_VERIFY=y
-CONFIG_CMD_DIAG=y
-CONFIG_CMD_LOG=y
+CONFIG_CMD_AVB=y
 CONFIG_OF_CONTROL=y
 CONFIG_SPL_OF_CONTROL=y
-CONFIG_OF_SPL_REMOVE_PROPS="clocks clock-names interrupt-parent"
+CONFIG_OF_LIST=""
 CONFIG_ENV_OVERWRITE=y
-CONFIG_ENV_IS_IN_SPI_FLASH=y
-CONFIG_ENV_FAT_INTERFACE="mmcblk1"
-CONFIG_ENV_FAT_DEVICE_AND_PART="1:1"
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_SYS_REDUNDAND_ENVIRONMENT=y
 CONFIG_SYS_RELOC_GD_ENV_ADDR=y
 CONFIG_SYS_MMC_ENV_DEV=1
-CONFIG_SYS_MMC_ENV_PART=1
-CONFIG_USE_DEFAULT_ENV_FILE=y
-CONFIG_DEFAULT_ENV_FILE="u-boot-default.txt"
 CONFIG_ENV_VARS_UBOOT_RUNTIME_CONFIG=y
 CONFIG_VERSION_VARIABLE=y
+CONFIG_NET_RETRY_COUNT=10
 CONFIG_BOOTP_SEND_HOSTNAME=y
-CONFIG_NET_RANDOM_ETHADDR=y
-CONFIG_NETCONSOLE=y
 CONFIG_SPL_DM=y
-CONFIG_SPL_DM_DEVICE_REMOVE=y
 CONFIG_SPL_DM_SEQ_ALIAS=y
 CONFIG_SPL_REGMAP=y
 CONFIG_SPL_SYSCON=y
 CONFIG_SPL_OF_TRANSLATE=y
 CONFIG_DWC_AHCI=y
-CONFIG_BOOTCOUNT_LIMIT=y
-CONFIG_BOOTCOUNT_ENV=y
-CONFIG_BUTTON=y
-CONFIG_BUTTON_GPIO=y
-CONFIG_PCF8575_GPIO=y
+CONFIG_CLK=y
+CONFIG_CLK_CDCE9XX=y
+CONFIG_USB_FUNCTION_FASTBOOT=y
+CONFIG_FASTBOOT_BUF_ADDR=0x82000000
+CONFIG_FASTBOOT_BUF_SIZE=0x2F000000
+CONFIG_FASTBOOT_USB_DEV=1
+CONFIG_FASTBOOT_FLASH=y
+CONFIG_FASTBOOT_FLASH_MMC_DEV=1
 CONFIG_DM_I2C=y
-CONFIG_DM_KEYBOARD=y
-CONFIG_LED=y
 CONFIG_MISC=y
 CONFIG_SUPPORT_EMMC_BOOT=y
-CONFIG_MMC_IO_VOLTAGE=y
-CONFIG_MMC_UHS_SUPPORT=y
-CONFIG_MMC_HS200_SUPPORT=y
-CONFIG_SPL_MMC_HS200_SUPPORT=y
 CONFIG_MMC_OMAP_HS=y
+CONFIG_HSMMC2_8BIT=y
 CONFIG_MTD=y
 CONFIG_DM_SPI_FLASH=y
-CONFIG_SF_DEFAULT_MODE=0
 CONFIG_SF_DEFAULT_SPEED=76800000
-CONFIG_SPI_FLASH_WINBOND=y
+CONFIG_SPI_FLASH_SPANSION=y
 CONFIG_PHY_ATHEROS=y
-CONFIG_PHY_MICREL=y
-CONFIG_PHY_MICREL_KSZ8XXX=y
-CONFIG_PHY_TI_DP83867=y
 CONFIG_PHY_FIXED=y
-CONFIG_DM_MDIO=y
-CONFIG_DM_ETH_PHY=y
-CONFIG_PHY_GIGE=y
-CONFIG_RGMII=y
 CONFIG_MII=y
 CONFIG_DRIVER_TI_CPSW=y
-CONFIG_PCI=y
-CONFIG_SPL_PHY=y
 CONFIG_PIPE3_PHY=y
 CONFIG_OMAP_USB2_PHY=y
-CONFIG_PHY_CADENCE_SIERRA=y
-CONFIG_PINCTRL=y
 CONFIG_DM_PMIC=y
 CONFIG_PMIC_PALMAS=y
 CONFIG_DM_REGULATOR=y
-CONFIG_DM_REGULATOR_FIXED=y
-CONFIG_DM_REGULATOR_GPIO=y
 CONFIG_DM_REGULATOR_PALMAS=y
 CONFIG_PALMAS_POWER=y
-CONFIG_DM_PWM=y
-CONFIG_RESET_DRA7=y
+# CONFIG_SCSI is not set
 CONFIG_DM_SCSI=y
 CONFIG_DM_SERIAL=y
-CONFIG_SOUND=y
 CONFIG_SPI=y
 CONFIG_DM_SPI=y
 CONFIG_TI_QSPI=y
-CONFIG_TIMER=y
-CONFIG_OMAP_TIMER=y
+# CONFIG_DM_THERMAL is not set
 CONFIG_USB=y
 CONFIG_DM_USB_GADGET=y
 CONFIG_SPL_DM_USB_GADGET=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
+# CONFIG_USB_XHCI_DWC3_OF_SIMPLE is not set
+CONFIG_USB_XHCI_OMAP=y
 CONFIG_USB_DWC3=y
-CONFIG_USB_DWC3_OMAP=y
 CONFIG_USB_DWC3_GENERIC=y
-CONFIG_USB_DWC3_PHY_OMAP=y
 CONFIG_USB_GADGET=y
 CONFIG_USB_GADGET_MANUFACTURER="Texas Instruments"
 CONFIG_USB_GADGET_VENDOR_NUM=0x0451
 CONFIG_USB_GADGET_PRODUCT_NUM=0xd022
-CONFIG_USB_GADGET_DOWNLOAD=y
-CONFIG_CC_OPTIMIZE_LIBS_FOR_SPEED=y
-# CONFIG_SPL_USE_TINY_PRINTF is not set
-CONFIG_SPL_LZO=y
-CONFIG_SPL_SPI_FLASH_SUPPORT=y
-CONFIG_SPL_SPI=y
-CONFIG_SPL_SPI_FLASH_TINY=y
-CONFIG_SPL_SPI_LOAD=y
-CONFIG_SYS_SPI_U_BOOT_OFFS=0x10000
+CONFIG_LIBAVB=y
