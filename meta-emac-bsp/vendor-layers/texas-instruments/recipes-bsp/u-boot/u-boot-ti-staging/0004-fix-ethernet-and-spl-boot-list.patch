From d657b696607ff3a13b990bf3179b37c04b449be7 Mon Sep 17 00:00:00 2001
From: Brenden Tisler <btisler@emacinc.com>
Date: Mon, 24 Jul 2023 17:57:10 -0500
Subject: [PATCH] fix ethernet and spl boot list

Signed-off-by: Brenden Tisler <btisler@emacinc.com>
---
 board/emacinc/som-5728m/board.c    | 63 ++++++++++--------------------
 board/emacinc/som-5728m/mux_data.h |  6 +--
 2 files changed, 24 insertions(+), 45 deletions(-)

diff --git a/board/emacinc/som-5728m/board.c b/board/emacinc/som-5728m/board.c
index 8f1ae5483f..bfd35059ef 100644
--- a/board/emacinc/som-5728m/board.c
+++ b/board/emacinc/som-5728m/board.c
@@ -19,6 +19,9 @@
 #include <serial.h>
 #include <usb.h>
 #include <errno.h>
+#ifdef CONFIG_SPL_BUILD
+#include <spl.h>
+#endif
 #include <asm/omap_common.h>
 #include <asm/omap_sec_common.h>
 #include <asm/emif.h>
@@ -59,6 +62,7 @@ static int board_bootmode_has_emmc(void);
 DECLARE_GLOBAL_DATA_PTR;
 
 #define GPIO_STATUS_LED		GPIO_TO_PIN(3, 0)
+#define GPIO_PHY_RST GPIO_TO_PIN(4, 25)
 
 #define SYSINFO_BOARD_NAME_MAX_LEN	45
 
@@ -263,6 +267,13 @@ void do_board_detect(void)
 {
 }
 
+void board_boot_order(u32 *spl_boot_list)
+{
+	spl_boot_list[0] = spl_boot_device();
+	if (spl_boot_list[0] != BOOT_DEVICE_SPI)
+		spl_boot_list[1] = BOOT_DEVICE_SPI;
+}
+
 #else	/* CONFIG_SPL_BUILD */
 
 /* Override function to read eeprom information: actual i2c read done by SPL*/
@@ -388,6 +399,16 @@ int board_late_init(void)
 	return 0;
 }
 
+int last_stage_init(void) {
+	udelay(100000);
+	gpio_request(GPIO_PHY_RST, "phy_rst");
+	gpio_direction_output(GPIO_PHY_RST, 0);
+	udelay(500000);
+	gpio_direction_output(GPIO_PHY_RST, 1);
+	udelay(3000000);
+	return 0;
+}
+
 void set_muxconf_regs(void)
 {
 	do_set_mux32((*ctrl)->control_padconf_core_base,
@@ -520,41 +541,6 @@ static struct cpsw_platform_data cpsw_data = {
 	.version		= CPSW_CTRL_VERSION_2,
 };
 
-static int ar8031_phy_fixup(struct phy_device *phydev)
-{
-	unsigned short val;
-
-	/* To enable AR8031 ouput a 125MHz clk from CLK_25M */
-	phy_write(phydev, MDIO_DEVAD_NONE, 0xd, 0x7);
-	phy_write(phydev, MDIO_DEVAD_NONE, 0xe, 0x8016);
-	phy_write(phydev, MDIO_DEVAD_NONE, 0xd, 0x4007);
-
-	val = phy_read(phydev, MDIO_DEVAD_NONE, 0xe);
-	val &= 0xffe3;
-	val |= 0x18;
-	phy_write(phydev, MDIO_DEVAD_NONE, 0xe, val);
-
-	/* introduce tx clock delay */
-	phy_write(phydev, MDIO_DEVAD_NONE, 0x1d, 0x5);
-	val = phy_read(phydev, MDIO_DEVAD_NONE, 0x1e);
-	val |= 0x0100;
-	phy_write(phydev, MDIO_DEVAD_NONE, 0x1e, val);
-
-	return 0;
-}
-
-int board_phy_config(struct phy_device *phydev)
-{
-	ar8031_phy_fixup(phydev);
-
-	if (phydev->drv->config){
-		printf("%s conf", phydev->drv->name);
-		phydev->drv->config(phydev);
-	};
-
-	return 0;
-}
-
 static u64 mac_to_u64(u8 mac[6])
 {
 	int i;
@@ -634,13 +620,6 @@ static inline void status_led_enable(void)
 int board_early_init_f(void)
 {
 	status_led_enable();
-#define GPIO_PHY_RST GPIO_TO_PIN(4, 25)
-
-	gpio_request(GPIO_PHY_RST, "phy_rst");
-	gpio_direction_output(GPIO_PHY_RST, 0);
-	udelay(100000);
-	gpio_direction_output(GPIO_PHY_RST, 1);
-	udelay(500000);
 	return 0;
 }
 #endif
diff --git a/board/emacinc/som-5728m/mux_data.h b/board/emacinc/som-5728m/mux_data.h
index ba4e4e9795..bdb63548ba 100644
--- a/board/emacinc/som-5728m/mux_data.h
+++ b/board/emacinc/som-5728m/mux_data.h
@@ -60,8 +60,8 @@ const struct pad_conf_entry core_padconf_array_essential_som_5728m[] = {
 	{VIN2A_D13, 0x5000A}, /* C2 vin2a_d13.eQEP3A_in */
 	{VIN2A_D14, 0x5000A}, /* C3 vin2a_d14.eQEP3B_in */
 	{VIN2A_D15, 0x5000A}, /* C4 vin2a_d15.eQEP3_index */
-	{VIN2A_D10, 0x10003}, /* D3 vin2a_d10.mdio_mclk */
-	{VIN2A_D11, 0x10003}, /* F6 vin2a_d11.mdio_d */
+	{VIN2A_D10, (M3 | PIN_OUTPUT | SLEWCONTROL)}, /* D3 vin2a_d10.mdio_mclk */
+	{VIN2A_D11, (M3 | PIN_INPUT | SLEWCONTROL)}, /* F6 vin2a_d11.mdio_d */
 	{RMII_MHZ_50_CLK, (M14 | PIN_INPUT_PULLUP)},	/* RMII_MHZ_50_CLK.gpio5_17 */
 	{RGMII0_RXD1, 0x50100}, /* Y2 rgmii0_rxd1.rgmii0_rxd1 */
 	{RGMII0_RXD2, 0x50100}, /* V3 rgmii0_rxd2.rgmii0_rxd2 */
@@ -148,7 +148,7 @@ const struct pad_conf_entry core_padconf_array_essential_som_5728m[] = {
 	{VIN2A_D9, 0x5000E}, /* E6 vin2a_d9.gpio4_10 */
 	{VIN2A_D12, 0x5000E}, /* D5 vin2a_d12.gpio4_13 */
 	{VIN2A_D16, 0x5000E}, /* B2 vin2a_d16.gpio4_24 */
-	{VIN2A_D17, 0x5000E}, /* D6 vin2a_d17.gpio4_25 */
+	{VIN2A_D17, 0x2000E}, /* D6 vin2a_d17.gpio4_25 */
 	{VIN2A_D18, 0x5000E}, /* C5 vin2a_d18.gpio4_26 */
 	{VIN2A_D19, 0x5000E}, /* A3 vin2a_d19.gpio4_27 */
 	{VIN2A_D20, 0x5000E}, /* B3 vin2a_d20.gpio4_28 */
