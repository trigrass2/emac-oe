.initenv-script: &initenv-script
  - git submodule sync --recursive
  - git submodule update --init --recursive
  - cd repo-tool
  - ./init-build.sh -c
  - ./init-build.sh -g "$REPO_TOOL_GROUPS"
  - cat ${CI_PROJECT_DIR}/conf/bblayers.conf.sample $LAYERS_SAMPLE > ${CI_PROJECT_DIR}/repo-tool/build/${DISTRO_CODENAME}/conf/bblayers.conf
  - |
    export BB_ENV_PASSTHROUGH_ADDITIONS="$BB_ENV_PASSTHROUGH_ADDITIONS \
      EMAC_CLIENT_NAME \
      EMAC_IMAGE \
      EMAC_DISPLAY_HW \
      EMAC_DISPLAY \
      EMAC_SHELLMANAGER \
      EMAC_INITMANAGER \
      EMAC_NETWORKMANAGER \
      EMAC_AUDIOMANAGER \
      EMAC_PACKAGEMANAGER"
  - source setup_env.sh
  - export

.start-bb-after-close: &start-bb-after-close
  - cd repo-tool
  - source start_afterclose.sh
  - |
    export BB_ENV_PASSTHROUGH_ADDITIONS="$BB_ENV_PASSTHROUGH_ADDITIONS \
      EMAC_CLIENT_NAME \
      EMAC_IMAGE \
      EMAC_DISPLAY_HW \
      EMAC_DISPLAY \
      EMAC_SHELLMANAGER \
      EMAC_INITMANAGER \
      EMAC_NETWORKMANAGER \
      EMAC_AUDIOMANAGER \
      EMAC_PACKAGEMANAGER"

.default-no-fetch-manual: &default-no-fetch-manual
  variables:
    GIT_STRATEGY: none
  tags:
    - oebuilder
    - bitbake
  when: manual
  allow_failure: true
  
init-env:
  stage: debug
  variables:
    GIT_STRATEGY: fetch
  when: manual
  allow_failure: true
  tags:
    - oebuilder
    - bitbake
  script:
    - *initenv-script

clean-bitbake-locks:
  stage: debug
  <<: *default-no-fetch-manual
  script:
    - pushd repo-tool/build/${DISTRO_CODENAME}
    - rm bitbake.*

clean-recipe:
  stage: debug
  <<: *default-no-fetch-manual
  script:
    - test ! -z $RECIPE_NAME
    - *start-bb-after-close
    - bitbake $RECIPE_NAME -c clean

clean-recipe-sstate:
  stage: debug
  <<: *default-no-fetch-manual
  script:
    - test ! -z $RECIPE_NAME
    - *start-bb-after-close
    - bitbake $RECIPE_NAME -c cleansstate

clean-image:
  stage: debug
  extends: clean-recipe
  variables:
    RECIPE_NAME: $EMAC_IMAGE

clean-image-sstate:
  stage: debug
  extends: clean-recipe-sstate
  variables:
    RECIPE_NAME: $EMAC_IMAGE
